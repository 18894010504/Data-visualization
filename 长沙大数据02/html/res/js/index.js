"use strict";Date.prototype.Format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var a in t)new RegExp("("+a+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[a]:("00"+t[a]).substr((""+t[a]).length)));return e};var getQueryString=function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),a=window.location.search.substr(1).match(t);return null!=a?unescape(a[2]):null};ko.components.register("dashboard-grid",{viewModel:{createViewModel:function(e,t){return new function(e,t){var a=null;this.widgets=e.widgets,this.afterAddWidget=function(e){null==a&&(a=$(t.element).find(".grid-stack").gridstack({auto:!1,width:4,cellHeight:$(".page").height()/3,verticalMargin:0}).data("gridstack"));var i=_.find(e,function(e){return 1==e.nodeType});a.addWidget(i),ko.utils.domNodeDisposal.addDisposeCallback(i,function(){a.removeWidget(i)}),$(i).find(".page-item").load("modules/"+$(i).attr("data-gs-module")+"/index.html")}}(e,t)}},template:['<div class="grid-stack" data-bind="foreach: {data: widgets, afterRender: afterAddWidget}">',"   <div class=\"grid-stack-item\" data-bind=\"attr: {'data-gs-x': $data.x, 'data-gs-y': $data.y, 'data-gs-width': $data.width, 'data-gs-height': $data.height, 'data-gs-auto-position': $data.auto_position, 'data-gs-module': $data.module}\">",'       <div class="oprate">','           <div class="grid-stack-item-content icon ncicon-stealth"></div>','           <i class="icon ncicon-offline delete" data-bind="click: $root.deleteWidget"></i>',"       </div>",'       <div class="page-item-box"><div class="page-item"></div></div>',"   </div>","</div> "].join("")}),$.getJSON("configure.json").success(function(e){JSON.parse(localStorage.getItem("configure"))?JSON.parse(localStorage.getItem("configure")):localStorage.setItem("configure",JSON.stringify(e));var t=JSON.parse(localStorage.getItem("configure"));$.getJSON("modules/package.json").success(function(e){t.modules=e;new Vue({el:"#page_container",data:{headerTime:{date:"",time:""},controller:{},editObj:{},configureDatas:t||{},pageList:{index:0,data:{}}},created:function(){var e=this;document.title=e.configureDatas.basics.txtName,e.setHeaderTime(),setInterval(function(){e.setHeaderTime()},1e3);var t=document.getElementsByTagName("html")[0],a=document.body.clientHeight/640*20;t.style.fontSize=a+"px"},mounted:function(){var e=this,t=function(t){var a=this;this.widgets=ko.observableArray(t),this.deleteWidget=function(e){return a.widgets.remove(e),$(".module-list .box-wrap ul li#"+e.module).removeClass("active"),!1},this.saveWidget=function(){if(""==$("#page_name").val())$.smkConfirm({text:"页面名称不能为空，请填写页面名称！",accept:"确定",cancel:!1},function(e){});else if(this.serializedData=_.map($(".grid-stack > .grid-stack-item:visible"),function(e){e=$(e);var t=e.data("_gridstack_node");return{x:t.x,y:t.y,width:t.width,height:t.height,module:t.module}},this),this.serializedData.length>0&&this.serializedData.length<=12){var t=new Object;if(e.editObj.page)t.id=e.editObj.page.id,t.name=$("#page_name").val(),t.desc=$("#page_desc").val(),t.widgets=this.serializedData,e.configureDatas.pages[e.editObj.groupIndex].data.splice(e.editObj.pageIndex,1),e.configureDatas.pages[$("#page_group").val()].data.push(t);else{var i=Date.parse(new Date)/1e3;t.id="page_"+i,t.name=$("#page_name").val(),t.desc=$("#page_desc").val(),t.widgets=this.serializedData,e.configureDatas.pages[$("#page_group").val()].data.push(t)}localStorage.setItem("configure",JSON.stringify(e.configureDatas)),$.smkConfirm({text:"页面保存成功！",accept:"确定",cancel:!1},function(e){}),$(".page-container").removeClass("edit-ing"),$(".module-list").removeClass("side-open side-close"),$("#pageBasicsModal").modal("hide"),a.widgets.removeAll(),$("#page_desc").val(""),e.editObj={}}return!1},this.saveGroup=function(){if(""==$("#group_name").val())$.smkConfirm({text:"分类名称不能为空，请填写分类名称！",accept:"确定",cancel:!1},function(e){});else if(0==$(".modal .page-icons .active").length)$.smkConfirm({text:"请选择一个菜单图标！",accept:"确定",cancel:!1},function(e){});else{var t=e.configureDatas.pages;if(""==e.editGroupId){var a=new Object,i=Date.parse(new Date)/1e3;a.id="group_"+i,a.typeName=$("#group_name").val(),a.icon=$(".modal .page-icons li.active").attr("data-name"),a.data=[],t.push(a)}else $.each(t,function(t,a){if(a.id==e.editGroupId)return a.typeName=$("#group_name").val(),a.icon=$(".modal .page-icons li.active").attr("data-name"),!1});localStorage.setItem("configure",JSON.stringify(e.configureDatas)),$.smkConfirm({text:"分类保存成功！",accept:"确定",cancel:!1},function(e){}),$(".page-container").removeClass("edit-ing"),$("#groupBasicsModal").modal("hide"),e.editGroupId=""}return!1}},a=[];this.controller=new t(a),ko.applyBindings(this.controller),$(".box-wrap, .page, .nav-icons").niceScroll({cursorcolor:"#1f4866",autohidemode:!0,cursorwidth:"4px",cursorborderradius:0}),$(".side-bar .handle").click(function(){$(this).parents(".side-bar").toggleClass("side-open side-close")}),$(".module-list .type-name").click(function(){$(this).parents(".type-box").toggleClass("open")}),$(".modal .page-icons li").click(function(){$(this).addClass("active").siblings().removeClass("active")}),sessionStorage.getItem("hasLogin")?getQueryString("groupNum")&&getQueryString("pageNum")?this.loadPage(getQueryString("groupNum"),getQueryString("pageNum")):window.location.href="index.html?groupNum=0&pageNum=0&timestamp="+(new Date).getTime():(alert("登录已过期，请重新登录！"),window.location.href="login.html"),$(".page-list").on("click"," .type-name",function(){$(this).parents(".type-box").toggleClass("open")})},methods:{setHeaderTime:function(){this.headerTime.date=(new Date).Format("yyyy年MM月dd日"),this.headerTime.time=(new Date).Format("hh:mm:ss")},setup:function(){this.controller.widgets.removeAll(),$(".page-container").hasClass("edit-true")?($(".page-container").removeClass("edit-true edit-ing"),$(".side-bar").removeClass("side-open side-close"),window.location.href="index.html?pageNum=0&timestamp="+(new Date).getTime()):($(".page-container").addClass("edit-true"),$(".page-list").addClass("side-open"))},addPageFun:function(){$(".module-list").hasClass("side-close")||$(".module-list").addClass("side-open"),$(".page-container").addClass("edit-ing"),$("#page_name").val(""),$(".modal .page-icons li").removeClass("active"),$(".module-list .box-wrap ul li").removeClass("active"),this.editObj={},this.controller.widgets.removeAll()},addPage:function(){var e=this;$(".page-container.edit-ing").length>0?$.smkConfirm({text:"确定离开当前编辑页面？",accept:"确定",cancel:"取消"},function(t){t&&e.addPageFun()}):e.addPageFun()},moduleDesc:function(e,t){$("#myModal .modal-title").text(this.configureDatas.modules[e].data[t].name),$("#myModal .modal-body p").text(this.configureDatas.modules[e].data[t].description),$("#myModal").modal({backdrop:!1})},selectModule:function(e,t){var a=this;$(".grid-stack-item").length>11?$.smkConfirm({text:"每个页面模块不能多于12个！",accept:"确定",cancel:!1},function(e){}):(a.controller.widgets.push({x:0,y:0,width:a.configureDatas.modules[e].data[t].width,height:a.configureDatas.modules[e].data[t].height,auto_position:!0,module:a.configureDatas.modules[e].data[t].folderName}),$(".module-list .type-box").eq(e).find("li").eq(t).addClass("active"))},deleteModule:function(e,t){$('.grid-stack-item[data-gs-module="'+this.configureDatas.modules[e].data[t].folderName+'"] .oprate .delete').click()},clearPage:function(){this.controller.widgets.removeAll()},pageBasics:function(){0==$(".grid-stack-item").length?$.smkConfirm({text:"页面模块不能为空，请选择模块！",accept:"确定",cancel:!1},function(e){}):$(".edit-area").height()>$(".page").height()?$.smkConfirm({text:"页面内容不能超出一屏，请重新调整页面！",accept:"确定",cancel:!1},function(e){}):$("#pageBasicsModal").modal({backdrop:!1})},editPageFun:function(e){var t=this;t.editObj=e;var a=t.controller.widgets;a.removeAll(),$(".module-list").hasClass("side-close")||$(".module-list").addClass("side-open"),$(".page-container").addClass("edit-ing"),$(".module-list .box-wrap li").removeClass("active"),$("#page_name").val(e.page.name),$("#page_group").val(e.groupIndex),$("#page_desc").val(e.page.desc),$.each(e.page.widgets,function(e,t){a.push({x:t.x,y:t.y,width:t.width,height:t.height,auto_position:!1,module:t.module}),$(".module-list .box-wrap ul li#"+t.module).addClass("active")})},editPage:function(e,t,a,i){var s=this,o={groupIndex:e,group:t,pageIndex:a,page:i};$(".page-container.edit-ing").length>0?$.smkConfirm({text:"确定离开当前编辑页面？",accept:"确定",cancel:"取消"},function(e){e&&s.editPageFun(o)}):s.editPageFun(o)},deletePage:function(e,t){var a=this;$.smkConfirm({text:"确定删除该页面？",accept:"确定",cancel:"取消"},function(i){i&&(a.configureDatas.pages[e].data.splice(t,1),localStorage.setItem("configure",JSON.stringify(a.configureDatas)))})},pageUp:function(e,t){var a=this.configureDatas.pages[e].data,i=a[t];a.splice(t,1),a.splice(t-1,0,i),localStorage.setItem("configure",JSON.stringify(this.configureDatas))},pageDown:function(e,t){var a=this.configureDatas.pages[e].data,i=a[t];a.splice(t,1),a.splice(t+1,0,i),localStorage.setItem("configure",JSON.stringify(this.configureDatas))},loadPage:function(e,t){this.controller.widgets.removeAll(),$(".nav-list").eq(e).addClass("active").siblings().removeClass("active");for(var a=this.configureDatas.pages[e].data[t].widgets,i=0;i<a.length;i++)this.controller.widgets.push({x:a[i].x,y:a[i].y,width:a[i].width,height:a[i].height,auto_position:!1,module:a[i].module})},hrefPage:function(e,t){window.location.href="index.html?groupNum="+e+"&pageNum="+t+"&timestamp="+(new Date).getTime()},openGroupList:function(e,t){var a=this;a.pageList.index=e,a.pageList.data=t.data,$(".nav-links").addClass("open").siblings(".page-menu").find(".nav-list").removeClass("hover").eq(e).addClass("hover")},closeGroupList:function(){$(".nav-links").removeClass("open").siblings(".page-menu").find(".nav-list").removeClass("hover")},groupBasics:function(e){var t=this;e?(t.editGroupId=e.id,$("#group_name").val(e.typeName),$(".modal .page-icons li").removeClass("active"),$(".modal .page-icons li[data-name="+e.icon+"]").addClass("active")):(t.editGroupId="",$("#group_name").val(""),$(".modal .page-icons li").removeClass("active")),$("#groupBasicsModal").modal({backdrop:!1})},deleteGroup:function(e){var t=this;e.data.length>0?$.smkConfirm({text:"该分类包含页面，不可删除！",accept:"确定",cancel:!1},function(e){}):$.smkConfirm({text:"确定删除该分类？",accept:"确定",cancel:"取消"},function(a){if(a){var i=t.configureDatas.pages;$.each(i,function(a,s){if(s.id==e.id)return i.splice(a,1),localStorage.setItem("configure",JSON.stringify(t.configureDatas)),!1})}})}}})})});